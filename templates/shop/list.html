{% extends 'base.html' %}
{% load static %}
{% load main_extras %}

{% block title %}Magazin - Răsfățul Pescarului{% endblock %}

{% block content %}
<div class="container py-5 mt-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'main:home' %}">Acasă</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                {% if category %}
                {{ category.name }}
                {% else %}
                Magazin
                {% endif %}
            </li>
        </ol>
    </nav>

    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3">
            <!-- Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Caută</h5>
                    <form action="{% url 'main:shop' %}" method="get">
                        <div class="input-group">
                            <input type="text" class="form-control" name="q" 
                                   placeholder="Caută produse..." value="{{ search_query|default:'' }}">
                            <button class="btn btn-outline-success" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Categories -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Categorii</h5>
                    <div class="list-group list-group-flush">
                        <a href="{% url 'main:shop' %}" 
                           class="list-group-item list-group-item-action {% if not category %}active{% endif %}">
                            Toate produsele
                        </a>
                        {% for cat in categories %}
                        <a href="{% url 'main:shop_category' cat.slug %}" 
                           class="list-group-item list-group-item-action {% if category.id == cat.id %}active{% endif %}">
                            {{ cat.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="col-lg-9">
            <!-- Results info -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    {% if search_query %}
                    <h4>Rezultate pentru "{{ search_query }}"</h4>
                    {% elif category %}
                    <h4>{{ category.name }}</h4>
                    {% else %}
                    <h4>Toate produsele</h4>
                    {% endif %}
                </div>
                <div class="text-muted">
                    {{ products.paginator.count }} produse găsite
                </div>
            </div>

            <!-- Products -->
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for product in products %}
                <div class="col">
                    <div class="card h-100">
                        <!-- Product Image -->
                        {% if product.image %}
                        <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
                        {% else %}
                        <img src="{% static 'images/product-placeholder.png' %}" class="card-img-top" alt="{{ product.name }}">
                        {% endif %}
                        
                        <div class="card-body">
                            <!-- Product Name -->
                            <h5 class="card-title">{{ product.name }}</h5>
                            
                            <!-- Price -->
                            <p class="card-text text-success fw-bold mb-2">{{ product.price }} Lei</p>
                            
                            <!-- Stock Status -->
                            {% if product.stock_quantity > 0 %}
                            <span class="badge bg-success mb-2">În stoc</span>
                            {% else %}
                            <span class="badge bg-danger mb-2">Stoc epuizat</span>
                            {% endif %}
                            
                            <!-- Description -->
                            <p class="card-text text-muted small">
                                {{ product.description|truncatechars:100 }}
                            </p>
                            
                            <!-- Actions -->
                            <div class="d-grid gap-2">
                                <a href="{% url 'main:product_detail' product.slug %}" 
                                   class="btn btn-outline-success">
                                    Vezi detalii
                                </a>
                                {% if product.stock_quantity > 0 %}
                                <form method="post" action="{% url 'main:add_to_cart' %}" class="d-grid">
                                    {% csrf_token %}
                                    <input type="hidden" name="product_id" value="{{ product.id }}">
                                    <input type="hidden" name="quantity" value="1">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-shopping-cart me-2"></i>Adaugă în coș
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="alert alert-info">
                        Nu am găsit niciun produs care să corespundă criteriilor tale de căutare.
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if products.paginator.num_pages > 1 %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if products.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ products.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for i in products.paginator.page_range %}
                    <li class="page-item {% if products.number == i %}active{% endif %}">
                        <a class="page-link" href="?page={{ i }}{% if search_query %}&q={{ search_query }}{% endif %}">
                            {{ i }}
                        </a>
                    </li>
                    {% endfor %}

                    {% if products.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ products.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="cartToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-shopping-cart me-2"></i>
            <strong class="me-auto">Coș de cumpărături</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>
{% endblock %}
